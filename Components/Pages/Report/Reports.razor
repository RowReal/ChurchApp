@page "/reports"
@using ChurchApp.Services
@using ChurchApp.Models
@inject ReportingService ReportingService
@inject WorkerService WorkerService
@inject AuthService AuthService
@inject IJSRuntime JS

<PageTitle>Church Reports - Offering and Attendance</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>Church Reports</h1>
                <div>
                    <button class="btn btn-success me-2" @onclick="ExportToExcel">
                        <i class="fas fa-file-excel me-2"></i>Export to Excel
                    </button>
                    <button class="btn btn-primary" @onclick="PrintReport">
                        <i class="fas fa-print me-2"></i>Print Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-filter me-2"></i>Report Filters
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Start Date</label>
                    <input type="date" class="form-control" @bind="startDate" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">End Date</label>
                    <input type="date" class="form-control" @bind="endDate" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Report Type</label>
                    <select class="form-select" @bind="selectedReportType">
                        <option value="combined">Combined Report</option>
                        <option value="offering">Offering Report</option>
                        <option value="attendance">Attendance Report</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-primary me-2" @onclick="LoadReport">
                        <i class="fas fa-sync-alt me-2"></i>Generate Report
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="ClearFilters">
                        <i class="fas fa-times me-2"></i>Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Generating report...</p>
        </div>
    }
    else if (reportError)
    {
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>Error generating report: @errorMessage
        </div>
    }
    else
    {
        <!-- Combined Report -->
        @if (selectedReportType == "combined" && combinedReport != null)
        {
            <div class="row">
                <div class="col-12">
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h4 class="card-title mb-0">
                                <i class="fas fa-chart-bar me-2"></i>Combined Church Report
                            </h4>
                            <small class="opacity-75">Period: @combinedReport.ReportPeriod</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key Metrics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-white bg-success">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">@combinedReport.OfferingSummary.TotalAmount.ToString("C")</h4>
                                    <p class="card-text">Total Offerings</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-money-bill-wave fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-info">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">@combinedReport.AttendanceSummary.TotalAttendance.ToString("N0")</h4>
                                    <p class="card-text">Total Attendance</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-users fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-warning">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">@combinedReport.OfferingSummary.TotalRecords</h4>
                                    <p class="card-text">Offering Records</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-receipt fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-secondary">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">@combinedReport.AttendanceSummary.AverageAttendance.ToString("N1")</h4>
                                    <p class="card-text">Avg. Attendance</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-chart-line fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Sections -->
            <div class="row">
                <!-- Offering Breakdown -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Offering Breakdown</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Offering Type</th>
                                            <th class="text-end">Amount</th>
                                            <th class="text-end">Records</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in combinedReport.OfferingSummary.ByOfferingType)
                                        {
                                            <tr>
                                                <td>@item.OfferingTypeName</td>
                                                <td class="text-end">@item.TotalAmount.ToString("C")</td>
                                                <td class="text-end">@item.RecordCount</td>
                                            </tr>
                                        }
                                    </tbody>
                                    <tfoot class="table-group-divider">
                                        <tr class="fw-bold">
                                            <td>Total</td>
                                            <td class="text-end">@combinedReport.OfferingSummary.TotalAmount.ToString("C")</td>
                                            <td class="text-end">@combinedReport.OfferingSummary.TotalRecords</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Attendance Breakdown -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Attendance Breakdown</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Service</th>
                                            <th class="text-end">Total</th>
                                            <th class="text-end">Avg.</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in combinedReport.AttendanceSummary.ByService)
                                        {
                                            <tr>
                                                <td>@item.ServiceName</td>
                                                <td class="text-end">@item.TotalAttendance.ToString("N0")</td>
                                                <td class="text-end">@item.AverageAttendance.ToString("N1")</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>

                            <!-- Demographics -->
                            <div class="mt-3">
                                <h6>Demographics</h6>
                                <div class="row text-center">
                                    <div class="col-3">
                                        <div class="border rounded p-2">
                                            <div class="fw-bold text-primary">@combinedReport.AttendanceSummary.TotalMen</div>
                                            <small>Men</small>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="border rounded p-2">
                                            <div class="fw-bold text-success">@combinedReport.AttendanceSummary.TotalWomen</div>
                                            <small>Women</small>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="border rounded p-2">
                                            <div class="fw-bold text-warning">@combinedReport.AttendanceSummary.TotalTeenagers</div>
                                            <small>Teens</small>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="border rounded p-2">
                                            <div class="fw-bold text-info">@combinedReport.AttendanceSummary.TotalChildren</div>
                                            <small>Children</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Offering Only Report -->
        @if (selectedReportType == "offering" && offeringSummary != null)
        {
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-money-bill-wave me-2"></i>Offering Report
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Summary Cards -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h3 class="text-success">@offeringSummary.TotalAmount.ToString("C")</h3>
                                    <p class="mb-0">Total Offerings</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h3 class="text-primary">@offeringSummary.TotalRecords</h3>
                                    <p class="mb-0">Total Records</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h3 class="text-warning">@offeringSummary.AverageAmount.ToString("C")</h3>
                                    <p class="mb-0">Average Offering</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Records -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Date</th>
                                    <th>Offering Type</th>
                                    <th>Payment Mode</th>
                                    <th class="text-end">Amount</th>
                                    <th>Currency</th>
                                    <th>Recorded By</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var record in offeringRecords)
                                {
                                    var recordedByWorker = GetWorkerFromCache(record.RecordedByWorkerId);
                                    <tr>
                                        <td>@record.OfferingDate.ToString("yyyy-MM-dd")</td>
                                        <td>@record.OfferingTypeName</td>
                                        <td>
                                            <span class="badge bg-secondary">@record.PaymentMode</span>
                                        </td>
                                        <td class="text-end fw-bold">@record.Amount.ToString("C")</td>
                                        <td>
                                            <span class="badge bg-info">@record.Currency</span>
                                        </td>
                                        <td>
                                            @if (recordedByWorker != null)
                                            {
                                                <div>
                                                    <div>@recordedByWorker.FirstName @recordedByWorker.LastName</div>
                                                    <small class="text-muted">@recordedByWorker.WorkerId</small>
                                                </div>
                                            }
                                            else if (!string.IsNullOrEmpty(record.RecordedByWorkerId))
                                            {
                                                <div class="text-muted">Worker ID: @record.RecordedByWorkerId</div>
                                            }
                                            else
                                            {
                                                <span class="text-muted">Not recorded</span>
                                            }
                                        </td>
                                        <td>
                                            <span class="badge @GetStatusBadgeClass(record.Status)">@record.Status</span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot class="table-group-divider">
                                <tr class="fw-bold table-active">
                                    <td colspan="3">Total</td>
                                    <td class="text-end">@offeringSummary.TotalAmount.ToString("C")</td>
                                    <td colspan="3">@offeringSummary.TotalRecords records</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        }

        <!-- Attendance Only Report -->
        @if (selectedReportType == "attendance" && attendanceSummary != null)
        {
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-users me-2"></i>Attendance Report
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Summary Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h3 class="text-primary">@attendanceSummary.TotalAttendance.ToString("N0")</h3>
                                    <p class="mb-0">Total Attendance</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h3 class="text-success">@attendanceSummary.TotalRecords</h3>
                                    <p class="mb-0">Service Records</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h3 class="text-warning">@attendanceSummary.AverageAttendance.ToString("N1")</h3>
                                    <p class="mb-0">Average Attendance</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h3 class="text-danger">@attendanceSummary.ByService.Count</h3>
                                    <p class="mb-0">Service Types</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Demographics Summary -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">Demographics Summary</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-md-3">
                                            <div class="border rounded p-3 bg-primary bg-opacity-10">
                                                <div class="fw-bold text-primary fs-4">@attendanceSummary.TotalMen</div>
                                                <small class="text-muted">Men</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="border rounded p-3 bg-success bg-opacity-10">
                                                <div class="fw-bold text-success fs-4">@attendanceSummary.TotalWomen</div>
                                                <small class="text-muted">Women</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="border rounded p-3 bg-warning bg-opacity-10">
                                                <div class="fw-bold text-warning fs-4">@attendanceSummary.TotalTeenagers</div>
                                                <small class="text-muted">Teenagers</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="border rounded p-3 bg-info bg-opacity-10">
                                                <div class="fw-bold text-info fs-4">@attendanceSummary.TotalChildren</div>
                                                <small class="text-muted">Children</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Records -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Date</th>
                                    <th>Service</th>
                                    <th class="text-end">Men</th>
                                    <th class="text-end">Women</th>
                                    <th class="text-end">Teens</th>
                                    <th class="text-end">Children</th>
                                    <th class="text-end">Total</th>
                                    <th>Recorded By</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var record in attendanceRecords)
                                {
                                    var recordedByWorker = GetWorkerFromCache(record.RecordedByWorkerId);
                                    <tr>
                                        <td>@record.AttendanceDate.ToString("yyyy-MM-dd")</td>
                                        <td>
                                            <span class="badge bg-primary">@record.ServiceName</span>
                                        </td>
                                        <td class="text-end">@record.Men.ToString("N0")</td>
                                        <td class="text-end">@record.Women.ToString("N0")</td>
                                        <td class="text-end">@record.Teenagers.ToString("N0")</td>
                                        <td class="text-end">@record.Children.ToString("N0")</td>
                                        <td class="text-end fw-bold text-success">@record.Total.ToString("N0")</td>
                                        <td>
                                            @if (recordedByWorker != null)
                                            {
                                                <div>
                                                    <div>@recordedByWorker.FirstName @recordedByWorker.LastName</div>
                                                    <small class="text-muted">@recordedByWorker.WorkerId</small>
                                                </div>
                                            }
                                            else if (!string.IsNullOrEmpty(record.RecordedByWorkerId))
                                            {
                                                <div class="text-muted">Worker ID: @record.RecordedByWorkerId</div>
                                            }
                                            else
                                            {
                                                <span class="text-muted">Not recorded</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot class="table-group-divider">
                                <tr class="fw-bold table-active">
                                    <td colspan="2">Total</td>
                                    <td class="text-end">@attendanceSummary.TotalMen.ToString("N0")</td>
                                    <td class="text-end">@attendanceSummary.TotalWomen.ToString("N0")</td>
                                    <td class="text-end">@attendanceSummary.TotalTeenagers.ToString("N0")</td>
                                    <td class="text-end">@attendanceSummary.TotalChildren.ToString("N0")</td>
                                    <td class="text-end">@attendanceSummary.TotalAttendance.ToString("N0")</td>
                                    <td>@attendanceSummary.TotalRecords records</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    private DateTime? startDate;
    private DateTime? endDate;
    private string selectedReportType = "combined";
    private bool isLoading = false;
    private bool reportError = false;
    private string errorMessage = string.Empty;

    private CombinedReport? combinedReport;
    private OfferingSummary? offeringSummary;
    private AttendanceSummary? attendanceSummary;
    private List<OfferingRecord> offeringRecords = new();
    private List<AttendanceRecord> attendanceRecords = new();
    private Dictionary<string, Worker> workerCache = new();

    private IJSObjectReference? module;

    protected override async Task OnInitializedAsync()
    {
        // Set default date range to last 30 days
        endDate = DateTime.Today;
        startDate = DateTime.Today.AddDays(-30);
        
        await LoadReport();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Load the JS module
                module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/fileExport.js");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Failed to load JS module: {ex.Message}");
            }
        }
    }

    private async Task LoadReport()
    {
        isLoading = true;
        reportError = false;
        workerCache.Clear();
        StateHasChanged();

        try
        {
            switch (selectedReportType)
            {
                case "combined":
                    combinedReport = await ReportingService.GetCombinedReportAsync(startDate, endDate);
                    break;
                case "offering":
                    offeringSummary = await ReportingService.GetOfferingSummaryAsync(startDate, endDate);
                    offeringRecords = await ReportingService.GetOfferingReportAsync(startDate, endDate);
                    await PreloadWorkerNames(offeringRecords.Select(o => o.RecordedByWorkerId).ToList());
                    break;
                case "attendance":
                    attendanceSummary = await ReportingService.GetAttendanceSummaryAsync(startDate, endDate);
                    attendanceRecords = await ReportingService.GetAttendanceReportAsync(startDate, endDate);
                    await PreloadWorkerNames(attendanceRecords.Select(a => a.RecordedByWorkerId).ToList());
                    break;
            }
        }
        catch (Exception ex)
        {
            reportError = true;
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task PreloadWorkerNames(List<string> workerIds)
    {
        try
        {
            var uniqueWorkerIds = workerIds
                .Where(id => !string.IsNullOrEmpty(id))
                .Distinct()
                .ToList();

            foreach (var workerId in uniqueWorkerIds)
            {
                if (!workerCache.ContainsKey(workerId))
                {
                    var worker = await WorkerService.GetWorkerByWorkerIdAsync(workerId);
                    if (worker != null)
                    {
                        workerCache[workerId] = worker;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error preloading worker names: {ex.Message}");
        }
    }

    private Worker? GetWorkerFromCache(string workerId)
    {
        if (string.IsNullOrEmpty(workerId))
            return null;

        return workerCache.TryGetValue(workerId, out var worker) ? worker : null;
    }

    private void ClearFilters()
    {
        startDate = DateTime.Today.AddDays(-30);
        endDate = DateTime.Today;
        selectedReportType = "combined";
    }

    private async Task ExportToExcel()
    {
        try
        {
            if (module is null)
            {
                try
                {
                    module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/fileExport.js");
                }
                catch
                {
                    errorMessage = "Export functionality not available. Please refresh the page.";
                    reportError = true;
                    StateHasChanged();
                    return;
                }
            }

            var csvContent = await GenerateCsvContent();
            var fileName = $"ChurchReport_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
            
            await module.InvokeVoidAsync("downloadCsv", csvContent, fileName);
        }
        catch (Exception ex)
        {
            errorMessage = $"Export failed: {ex.Message}";
            reportError = true;
            StateHasChanged();
        }
    }

    private async Task PrintReport()
    {
        try
        {
            if (module is null)
            {
                await JS.InvokeVoidAsync("window.print");
            }
            else
            {
                await module.InvokeVoidAsync("printWindow");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Print failed: {ex.Message}";
            reportError = true;
            StateHasChanged();
        }
    }

    private async Task<string> GenerateCsvContent()
    {
        var lines = new List<string>();
        
        if (selectedReportType == "offering" && offeringRecords.Any())
        {
            lines.Add("Date,Offering Type,Payment Mode,Amount,Currency,Recorded By,Recorded By Worker ID,Status");
            foreach (var record in offeringRecords)
            {
                var recordedByWorker = await GetWorkerAsync(record.RecordedByWorkerId);
                var recordedByName = recordedByWorker != null 
                    ? $"{recordedByWorker.FirstName} {recordedByWorker.LastName}"
                    : "Unknown";
                    
                lines.Add($"{record.OfferingDate:yyyy-MM-dd},{EscapeCsvField(record.OfferingTypeName)},{EscapeCsvField(record.PaymentMode)},{record.Amount},{record.Currency},{EscapeCsvField(recordedByName)},{record.RecordedByWorkerId},{record.Status}");
            }
        }
        else if (selectedReportType == "attendance" && attendanceRecords.Any())
        {
            lines.Add("Date,Service,Men,Women,Teenagers,Children,Total,Recorded By,Recorded By Worker ID");
            foreach (var record in attendanceRecords)
            {
                var recordedByWorker = await GetWorkerAsync(record.RecordedByWorkerId);
                var recordedByName = recordedByWorker != null 
                    ? $"{recordedByWorker.FirstName} {recordedByWorker.LastName}"
                    : "Unknown";
                    
                lines.Add($"{record.AttendanceDate:yyyy-MM-dd},{EscapeCsvField(record.ServiceName)},{record.Men},{record.Women},{record.Teenagers},{record.Children},{record.Total},{EscapeCsvField(recordedByName)},{record.RecordedByWorkerId}");
            }
        }
        else if (selectedReportType == "combined" && combinedReport != null)
        {
            lines.Add("Report Type,Period,Total Offerings,Total Attendance,Average Attendance");
            lines.Add($"Combined Report,{combinedReport.ReportPeriod},{combinedReport.OfferingSummary.TotalAmount},{combinedReport.AttendanceSummary.TotalAttendance},{combinedReport.AttendanceSummary.AverageAttendance:F2}");
            
            if (combinedReport.OfferingSummary.ByOfferingType.Any())
            {
                lines.Add("");
                lines.Add("Offering Breakdown");
                lines.Add("Offering Type,Total Amount,Record Count");
                foreach (var item in combinedReport.OfferingSummary.ByOfferingType)
                {
                    lines.Add($"{EscapeCsvField(item.OfferingTypeName)},{item.TotalAmount},{item.RecordCount}");
                }
            }
            
            if (combinedReport.AttendanceSummary.ByService.Any())
            {
                lines.Add("");
                lines.Add("Attendance Breakdown");
                lines.Add("Service Name,Total Attendance,Average Attendance");
                foreach (var item in combinedReport.AttendanceSummary.ByService)
                {
                    lines.Add($"{EscapeCsvField(item.ServiceName)},{item.TotalAttendance},{item.AverageAttendance:F2}");
                }
            }
        }
        
        return string.Join(Environment.NewLine, lines);
    }

    private async Task<Worker?> GetWorkerAsync(string workerId)
    {
        if (string.IsNullOrEmpty(workerId))
            return null;

        // Check cache first
        if (workerCache.TryGetValue(workerId, out var cachedWorker))
            return cachedWorker;

        // If not in cache, fetch from database
        try
        {
            var worker = await WorkerService.GetWorkerByWorkerIdAsync(workerId);
            if (worker != null)
            {
                workerCache[workerId] = worker;
            }
            return worker;
        }
        catch
        {
            return null;
        }
    }

    private string EscapeCsvField(string field)
    {
        if (string.IsNullOrEmpty(field))
            return "";
            
        if (field.Contains(",") || field.Contains("\"") || field.Contains("\r") || field.Contains("\n"))
        {
            return "\"" + field.Replace("\"", "\"\"") + "\"";
        }
        return field;
    }

    private string GetStatusBadgeClass(string status)
    {
        return status?.ToLower() switch
        {
            "approved" => "bg-success",
            "pending" => "bg-warning",
            "rejected" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    public async ValueTask DisposeAsync()
    {
        if (module is not null)
        {
            try
            {
                await module.DisposeAsync();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error disposing JS module: {ex.Message}");
            }
        }
    }
}
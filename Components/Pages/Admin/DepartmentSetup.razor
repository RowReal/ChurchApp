@page "/admin/department-setup"
@layout Components.Layout.MainLayout
@using ChurchApp.Services
@using ChurchApp.Models
@using System.ComponentModel.DataAnnotations
@inject WorkerService WorkerService
@inject AuthService AuthService
@inject NavigationManager Navigation

@if (AuthService.IsAuthenticated && AuthService.CanAccessAdminPanel())
{
    <PageTitle>Department Setup - Admin Panel</PageTitle>

    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col">
                <h2>Department Setup</h2>
                <p class="text-muted">Manage church departments and assign leadership</p>
            </div>
            <div class="col-auto">
                <button class="btn btn-primary" @onclick="ShowCreateForm">
                    <i class="fas fa-plus me-2"></i>Add Department
                </button>
            </div>
        </div>

        <!-- Create Department Form (kept at top for quick add) -->
        @if (showCreateForm)
        {
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Add New Department</h5>
                </div>
                <div class="card-body">
                    <EditForm Model="@departmentModel" OnValidSubmit="@SaveDepartment">
                        <DataAnnotationsValidator />

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="name" class="form-label">Department Name *</label>
                                    <InputText id="name" @bind-Value="departmentModel.Name" class="form-control" />
                                    <ValidationMessage For="@(() => departmentModel.Name)" />
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-3">
                                    <label for="code" class="form-label">Code *</label>
                                    <InputText id="code" @bind-Value="departmentModel.Code" class="form-control" />
                                    <ValidationMessage For="@(() => departmentModel.Code)" />
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-3">
                                    <label class="form-label">Status</label>
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox" @bind="departmentModel.IsActive" id="isActive">
                                        <label class="form-check-label" for="isActive">
                                            @(departmentModel.IsActive ? "Active" : "Inactive")
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="directorateId" class="form-label">Directorate *</label>
                                    <select @bind="departmentModel.DirectorateId" class="form-select" id="directorateId">
                                        <option value="0">Select Directorate</option>
                                        @foreach (var directorate in activeDirectorates)
                                        {
                                            <option value="@directorate.Id">@directorate.Name (@directorate.Code)</option>
                                        }
                                    </select>
                                    <ValidationMessage For="@(() => departmentModel.DirectorateId)" />
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="headWorkerId" class="form-label">Head of Department</label>
                                    <select @bind="departmentModel.HeadWorkerId" class="form-select" id="headWorkerId">
                                        <option value="">Select Head of Department (Optional)</option>
                                        @foreach (var worker in availableHeads)
                                        {
                                            <option value="@worker.Id">@worker.FirstName @worker.LastName (@worker.WorkerId) - @worker.Role</option>
                                        }
                                    </select>
                                    <small class="form-text text-muted">Can be assigned later</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="assistantHeadWorkerId" class="form-label">Assistant Head of Department</label>
                                    <select @bind="departmentModel.AssistantHeadWorkerId" class="form-select" id="assistantHeadWorkerId">
                                        <option value="">Select Assistant Head (Optional)</option>
                                        @foreach (var worker in availableHeads)
                                        {
                                            <option value="@worker.Id">@worker.FirstName @worker.LastName (@worker.WorkerId) - @worker.Role</option>
                                        }
                                    </select>
                                    <small class="form-text text-muted">Can be assigned later</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="form-group mb-3">
                                    <label for="description" class="form-label">Description</label>
                                    <InputTextArea id="description" @bind-Value="departmentModel.Description" class="form-control" rows="3" />
                                </div>
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(successMessage))
                        {
                            <div class="alert alert-success">
                                @successMessage
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger">
                                @errorMessage
                            </div>
                        }

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-2"></i>Create Department
                            </button>
                            <button type="button" class="btn btn-secondary" @onclick="CancelCreate">Cancel</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        }

        <!-- Edit Department Modal -->
        @if (showEditModal && editingDepartment != null)
        {
            <div class="modal show d-block" tabindex="-1" role="dialog" style="background-color: rgba(0,0,0,0.5);">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">Edit Department: @editingDepartment.Name</h5>
                            <button type="button" class="btn-close btn-close-white" @onclick="CloseEditModal"></button>
                        </div>
                        <div class="modal-body">
                            <EditForm Model="@editDepartmentModel" OnValidSubmit="@UpdateDepartment">
                                <DataAnnotationsValidator />

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="edit-name" class="form-label">Department Name *</label>
                                            <InputText id="edit-name" @bind-Value="editDepartmentModel.Name" class="form-control" />
                                            <ValidationMessage For="@(() => editDepartmentModel.Name)" />
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group mb-3">
                                            <label for="edit-code" class="form-label">Code *</label>
                                            <InputText id="edit-code" @bind-Value="editDepartmentModel.Code" class="form-control" />
                                            <ValidationMessage For="@(() => editDepartmentModel.Code)" />
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Status</label>
                                            <div class="form-check form-switch mt-2">
                                                <input class="form-check-input" type="checkbox" @bind="editDepartmentModel.IsActive" id="edit-isActive">
                                                <label class="form-check-label" for="edit-isActive">
                                                    @(editDepartmentModel.IsActive ? "Active" : "Inactive")
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="edit-directorateId" class="form-label">Directorate *</label>
                                            <select @bind="editDepartmentModel.DirectorateId" class="form-select" id="edit-directorateId">
                                                <option value="0">Select Directorate</option>
                                                @foreach (var directorate in activeDirectorates)
                                                {
                                                    <option value="@directorate.Id">@directorate.Name (@directorate.Code)</option>
                                                }
                                            </select>
                                            <ValidationMessage For="@(() => editDepartmentModel.DirectorateId)" />
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="edit-headWorkerId" class="form-label">Head of Department</label>
                                            <select @bind="editDepartmentModel.HeadWorkerId" class="form-select" id="edit-headWorkerId">
                                                <option value="">Select Head of Department (Optional)</option>
                                                @foreach (var worker in availableHeads)
                                                {
                                                    <option value="@worker.Id">@worker.FirstName @worker.LastName (@worker.WorkerId) - @worker.Role</option>
                                                }
                                            </select>
                                            <small class="form-text text-muted">Can be assigned later</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="edit-assistantHeadWorkerId" class="form-label">Assistant Head of Department</label>
                                            <select @bind="editDepartmentModel.AssistantHeadWorkerId" class="form-select" id="edit-assistantHeadWorkerId">
                                                <option value="">Select Assistant Head (Optional)</option>
                                                @foreach (var worker in availableHeads)
                                                {
                                                    <option value="@worker.Id">@worker.FirstName @worker.LastName (@worker.WorkerId) - @worker.Role</option>
                                                }
                                            </select>
                                            <small class="form-text text-muted">Can be assigned later</small>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-12">
                                        <div class="form-group mb-3">
                                            <label for="edit-description" class="form-label">Description</label>
                                            <InputTextArea id="edit-description" @bind-Value="editDepartmentModel.Description" class="form-control" rows="3" />
                                        </div>
                                    </div>
                                </div>

                                @if (!string.IsNullOrEmpty(editErrorMessage))
                                {
                                    <div class="alert alert-danger">
                                        @editErrorMessage
                                    </div>
                                }
                            </EditForm>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CloseEditModal">Cancel</button>
                            <button type="button" class="btn btn-success" @onclick="UpdateDepartment">
                                <i class="fas fa-save me-2"></i>Update Department
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Units Modal -->
        @if (showUnitsModal && selectedDepartment != null)
        {
            <div class="modal show d-block" tabindex="-1" role="dialog" style="background-color: rgba(0,0,0,0.5);">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">Units in @selectedDepartment.Name</h5>
                            <button type="button" class="btn-close btn-close-white" @onclick="CloseUnitsModal"></button>
                        </div>
                        <div class="modal-body">
                            @if (selectedDepartment.Units?.Any() == true)
                            {
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Unit Name</th>
                                                <th>Leader</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var unit in selectedDepartment.Units)
                                            {
                                                <tr>
                                                    <td>@unit.Name</td>
                                                    <td>
                                                        @if (unit.LeaderWorkerId.HasValue)
                                                        {
                                                            var leader = workers.FirstOrDefault(w => w.Id == unit.LeaderWorkerId);
                                                            if (leader != null)
                                                            {
                                                                <span>@leader.FirstName @leader.LastName</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="text-muted">Not Assigned</span>
                                                            }
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">Not Assigned</span>
                                                        }
                                                    </td>
                                                    <td>
                                                        <span class="badge @(unit.IsActive ? "bg-success" : "bg-secondary")">
                                                            @(unit.IsActive ? "Active" : "Inactive")
                                                        </span>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-4">
                                    <i class="fas fa-layer-group fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">No units found in this department.</p>
                                    @if (selectedDepartment.IsActive)
                                    {
                                        <button class="btn btn-primary" @onclick="NavigateToUnitSetup">
                                            <i class="fas fa-plus me-2"></i>Add Unit
                                        </button>
                                    }
                                    else
                                    {
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            Cannot add units to an inactive department. Please activate the department first.
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CloseUnitsModal">Close</button>
                            @if (selectedDepartment.IsActive)
                            {
                                <button type="button" class="btn btn-primary" @onclick="NavigateToUnitSetup">
                                    <i class="fas fa-cog me-2"></i>Manage Units
                                </button>
                            }
                            else
                            {
                                <button type="button" class="btn btn-primary" disabled title="Cannot manage units for inactive departments">
                                    <i class="fas fa-cog me-2"></i>Manage Units
                                </button>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Departments List -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">All Departments</h5>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox"
                           @bind="showInactiveDepartments"
                           @bind:after="ApplyFilter"
                           id="showInactive">
                    <label class="form-check-label" for="showInactive">
                        Show Inactive Departments
                    </label>
                </div>
            </div>
            <div class="card-body">
                @if (filteredDepartments.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Department Name</th>
                                    <th>Directorate</th>
                                    <th>Head of Department</th>
                                    <th>Asst Head</th>
                                    <th>Units</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var department in filteredDepartments)
                                {
                                    <tr class="@(department.IsActive ? "" : "table-secondary")">
                                        <td><strong>@department.Code</strong></td>
                                        <td>
                                            <div class="fw-bold">@department.Name</div>
                                            @if (!string.IsNullOrEmpty(department.Description))
                                            {
                                                <small class="text-muted">@department.Description</small>
                                            }
                                        </td>
                                        <td>
                                            @if (department.Directorate != null)
                                            {
                                                <div class="fw-bold">@department.Directorate.Name</div>
                                                <small class="text-muted">@department.Directorate.Code</small>
                                            }
                                            else
                                            {
                                                <span class="text-muted">Not Assigned</span>
                                            }
                                        </td>
                                        <td>
                                            @if (department.HeadWorkerId.HasValue)
                                            {
                                                var head = workers.FirstOrDefault(w => w.Id == department.HeadWorkerId);
                                                if (head != null)
                                                {
                                                    <div>@head.FirstName @head.LastName</div>
                                                    <small class="text-muted">@head.WorkerId</small>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Not Assigned</span>
                                                }
                                            }
                                            else
                                            {
                                                <span class="text-muted">Not Assigned</span>
                                            }
                                        </td>
                                        <td>
                                            @if (department.AssistantHeadWorkerId.HasValue)
                                            {
                                                var asstHead = workers.FirstOrDefault(w => w.Id == department.AssistantHeadWorkerId);
                                                if (asstHead != null)
                                                {
                                                    <div>@asstHead.FirstName @asstHead.LastName</div>
                                                    <small class="text-muted">@asstHead.WorkerId</small>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Not Assigned</span>
                                                }
                                            }
                                            else
                                            {
                                                <span class="text-muted">Not Assigned</span>
                                            }
                                        </td>
                                        <td>
                                            @if (department.IsActive)
                                            {
                                                <a href="javascript:void(0)" class="unit-link" @onclick="() => ShowUnits(department)">
                                                    <span class="badge bg-info">
                                                        <i class="fas fa-layer-group me-1"></i>
                                                        @(department.Units?.Count ?? 0) Units
                                                    </span>
                                                </a>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary" title="Department is inactive - units cannot be managed">
                                                    <i class="fas fa-layer-group me-1"></i>
                                                    @(department.Units?.Count ?? 0) Units
                                                </span>
                                            }
                                        </td>
                                        <td>
                                            <span class="badge @(department.IsActive ? "bg-success" : "bg-secondary")">
                                                @(department.IsActive ? "Active" : "Inactive")
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                @if (department.IsActive)
                                                {
                                                    <button class="btn btn-sm btn-outline-primary" @onclick="() => EditDepartment(department)" title="Edit Department">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-info" @onclick="() => ManageUnits(department)" title="Manage Units">
                                                        <i class="fas fa-cog"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-warning" @onclick="() => ToggleDepartmentStatus(department, false)" title="Deactivate">
                                                        <i class="fas fa-pause"></i>
                                                    </button>
                                                }
                                                else
                                                {
                                                    <button class="btn btn-sm btn-outline-primary" disabled title="Cannot edit inactive departments">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-info" disabled title="Cannot manage units for inactive departments">
                                                        <i class="fas fa-cog"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-success" @onclick="() => ToggleDepartmentStatus(department, true)" title="Activate">
                                                        <i class="fas fa-play"></i>
                                                    </button>
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center py-4">
                        <i class="fas fa-building fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No departments found. Create your first department to get started.</p>
                    </div>
                }
            </div>
        </div>
    </div>
}
else if (AuthService.IsAuthenticated && !AuthService.CanAccessAdminPanel())
{
    <!-- Access denied content -->
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">Access Denied</h5>
                    </div>
                    <div class="card-body text-center">
                        <i class="fas fa-ban fa-3x text-danger mb-3"></i>
                        <h4>Access Denied</h4>
                        <p class="text-muted">You don't have permission to access this page.</p>
                        <a href="/" class="btn btn-primary">Return to Dashboard</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <!-- Not authenticated -->
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">Authentication Required</h5>
                    </div>
                    <div class="card-body text-center">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <h4>Please Log In</h4>
                        <p class="text-muted">You need to be logged in to access this page.</p>
                        <a href="/login" class="btn btn-primary">Go to Login</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Department> departments = new();
    private List<Department> filteredDepartments = new();
    private List<Directorate> directorates = new();
    private List<Directorate> activeDirectorates = new();
    private List<Worker> workers = new();
    private List<Worker> availableHeads = new();
    private Department? editingDepartment = null;
    private Department? selectedDepartment = null;
    private DepartmentModel departmentModel = new();
    private DepartmentModel editDepartmentModel = new();
    private bool showCreateForm = false;
    private bool showEditModal = false;
    private bool showUnitsModal = false;
    private bool showInactiveDepartments = true;
    private string successMessage = string.Empty;
    private string errorMessage = string.Empty;
    private string editErrorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            departments = await WorkerService.GetDepartmentsAsync() ?? new List<Department>();
            directorates = await WorkerService.GetDirectoratesAsync() ?? new List<Directorate>();
            activeDirectorates = directorates.Where(d => d.IsActive).ToList();
            workers = await WorkerService.GetAllWorkersAsync() ?? new List<Worker>();
            availableHeads = await WorkerService.GetAvailableDepartmentHeadsAsync() ?? new List<Worker>();
            ApplyFilter();
        }
        catch (Exception ex)
        {
            errorMessage = "Error loading data: " + ex.Message;
        }
    }

    private void ApplyFilter()
    {
        if (showInactiveDepartments)
        {
            filteredDepartments = departments
                .OrderBy(d => d.Directorate != null ? d.Directorate.Name : "ZZZ")
                .ThenBy(d => d.Name)
                .ToList();
        }
        else
        {
            filteredDepartments = departments
                .Where(d => d.IsActive)
                .OrderBy(d => d.Directorate != null ? d.Directorate.Name : "ZZZ")
                .ThenBy(d => d.Name)
                .ToList();
        }
        StateHasChanged();
    }

    private void ShowCreateForm()
    {
        editingDepartment = null;
        departmentModel = new DepartmentModel { IsActive = true };
        showCreateForm = true;
        successMessage = string.Empty;
        errorMessage = string.Empty;
    }

    private void EditDepartment(Department department)
    {
        if (!department.IsActive)
        {
            errorMessage = "Cannot edit an inactive department. Please activate it first.";
            return;
        }

        editingDepartment = department;
        editDepartmentModel = new DepartmentModel
        {
            Name = department.Name,
            Code = department.Code,
            Description = department.Description,
            DirectorateId = department.DirectorateId,
            HeadWorkerId = department.HeadWorkerId,
            AssistantHeadWorkerId = department.AssistantHeadWorkerId,
            IsActive = department.IsActive
        };
        showEditModal = true;
        editErrorMessage = string.Empty;
    }

    private void CancelCreate()
    {
        showCreateForm = false;
        departmentModel = new DepartmentModel();
        successMessage = string.Empty;
        errorMessage = string.Empty;
    }

    private void CloseEditModal()
    {
        showEditModal = false;
        editingDepartment = null;
        editDepartmentModel = new DepartmentModel();
        editErrorMessage = string.Empty;
    }

    private async Task SaveDepartment()
    {
        try
        {
            if (departmentModel.DirectorateId == 0)
            {
                errorMessage = "Please select a directorate.";
                return;
            }

            var newDepartment = new Department
            {
                Name = departmentModel.Name?.Trim() ?? string.Empty,
                Code = departmentModel.Code?.ToUpper().Trim() ?? string.Empty,
                Description = departmentModel.Description?.Trim() ?? string.Empty,
                DirectorateId = departmentModel.DirectorateId,
                HeadWorkerId = departmentModel.HeadWorkerId,
                AssistantHeadWorkerId = departmentModel.AssistantHeadWorkerId,
                IsActive = departmentModel.IsActive,
                CreatedDate = DateTime.UtcNow
            };

            await WorkerService.CreateDepartmentAsync(newDepartment);
            await LoadData();
            showCreateForm = false;
            departmentModel = new DepartmentModel();
            successMessage = "Department created successfully!";
        }
        catch (Exception ex)
        {
            errorMessage = "Error saving department: " + ex.Message;
        }
    }

    private async Task UpdateDepartment()
    {
        try
        {
            if (editingDepartment == null) return;

            if (editDepartmentModel.DirectorateId == 0)
            {
                editErrorMessage = "Please select a directorate.";
                return;
            }

            if (!editingDepartment.IsActive && !editDepartmentModel.IsActive)
            {
                editErrorMessage = "Cannot update an inactive department. Please activate it first.";
                return;
            }

            editingDepartment.Name = editDepartmentModel.Name?.Trim() ?? string.Empty;
            editingDepartment.Code = editDepartmentModel.Code?.ToUpper().Trim() ?? string.Empty;
            editingDepartment.Description = editDepartmentModel.Description?.Trim() ?? string.Empty;
            editingDepartment.DirectorateId = editDepartmentModel.DirectorateId;
            editingDepartment.HeadWorkerId = editDepartmentModel.HeadWorkerId;
            editingDepartment.AssistantHeadWorkerId = editDepartmentModel.AssistantHeadWorkerId;
            editingDepartment.IsActive = editDepartmentModel.IsActive;

            await WorkerService.UpdateDepartmentAsync(editingDepartment);
            await LoadData();
            CloseEditModal();
            successMessage = "Department updated successfully!";
        }
        catch (Exception ex)
        {
            editErrorMessage = "Error updating department: " + ex.Message;
        }
    }

    private async Task ToggleDepartmentStatus(Department department, bool isActive)
    {
        try
        {
            department.IsActive = isActive;
            await WorkerService.UpdateDepartmentAsync(department);
            await LoadData();
            successMessage = $"Department {(isActive ? "activated" : "deactivated")} successfully!";
        }
        catch (Exception ex)
        {
            errorMessage = "Error updating department status: " + ex.Message;
        }
    }

    private void ShowUnits(Department department)
    {
        selectedDepartment = department;
        showUnitsModal = true;
    }

    private void CloseUnitsModal()
    {
        showUnitsModal = false;
        selectedDepartment = null;
    }

    private void NavigateToUnitSetup()
    {
        if (selectedDepartment != null && selectedDepartment.IsActive)
        {
            Navigation.NavigateTo($"/admin/unit-setup?departmentId={selectedDepartment.Id}");
        }
        else
        {
            errorMessage = "Cannot manage units for an inactive department. Please activate the department first.";
        }
    }

    private void ManageUnits(Department department)
    {
        if (!department.IsActive)
        {
            errorMessage = "Cannot manage units for an inactive department. Please activate the department first.";
            return;
        }
        Navigation.NavigateTo($"/admin/unit-setup?departmentId={department.Id}");
    }
}

<style>
    .unit-link {
        text-decoration: none;
        cursor: pointer;
    }

        .unit-link:hover .badge {
            background-color: #0b5ed7 !important;
            transform: scale(1.05);
            transition: all 0.2s ease;
        }

    .modal {
        backdrop-filter: blur(5px);
    }

    .btn-group .btn {
        border-radius: 4px;
        margin: 1px;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .bg-success {
        background-color: #198754 !important;
    }

    .bg-secondary {
        background-color: #6c757d !important;
    }

    .bg-info {
        background-color: #0dcaf0 !important;
    }

    .table-secondary {
        background-color: rgba(108, 117, 125, 0.1);
    }

    .form-text.text-muted {
        font-size: 0.875rem;
        font-style: italic;
    }
</style>
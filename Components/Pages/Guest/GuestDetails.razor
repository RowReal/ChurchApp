@page "/guest/details/{Id:int}"
@layout Components.Layout.MainLayout
@using ChurchApp.Services
@using ChurchApp.Models
@inject GuestService GuestService
@inject AuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Guest Details - BCC ServiceHub</PageTitle>

@if (AuthService.IsAuthenticated)
{
    @if (!IsFIGDirectorateMember())
    {
        <div class="container mt-4">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card shadow-sm">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Access Restricted</h5>
                        </div>
                        <div class="card-body text-center py-4">
                            <i class="fas fa-lock fa-3x text-warning mb-3"></i>
                            <h4>Access Denied</h4>
                            <p class="text-muted">This section is only accessible to FIG Directorate members.</p>
                            <a href="/guest" class="btn btn-primary mt-2">
                                <i class="fas fa-arrow-left me-1"></i>Back to Guest Management
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else if (isLoading)
    {
        <div class="container mt-4">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card shadow-sm">
                        <div class="card-body text-center py-5">
                            <div class="spinner-border text-primary mb-3"></div>
                            <p>Loading guest details...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else if (guest == null)
    {
        <div class="container mt-4">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card shadow-sm">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0"><i class="fas fa-exclamation-circle me-2"></i>Guest Not Found</h5>
                        </div>
                        <div class="card-body text-center py-4">
                            <i class="fas fa-user-slash fa-3x text-danger mb-3"></i>
                            <h4>Guest Not Found</h4>
                            <p class="text-muted">The requested guest record could not be found or has been deleted.</p>
                            <div class="d-flex justify-content-center gap-2 mt-3">
                                <a href="/guest" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left me-1"></i>Back to Guest Management
                                </a>
                                <a href="/guest/first-timer" class="btn btn-primary">
                                    <i class="fas fa-list me-1"></i>View Today's Guests
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="container py-3">
            <!-- Success Message -->
            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success alert-dismissible fade show mb-3" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Success!</strong> @successMessage
                    <button type="button" class="btn-close" @onclick="ClearSuccessMessage"></button>
                </div>
            }

            <!-- Error Message -->
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger alert-dismissible fade show mb-3" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i> @errorMessage
                    <button type="button" class="btn-close" @onclick="ClearErrorMessage"></button>
                </div>
            }

            <!-- Main Header - Very Bold -->
            <div class="main-header mb-4">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h2 class="mb-1 fw-bold">
                            <i class="fas fa-user-circle me-2"></i>
                            Guest Details - @guest.Title @guest.FirstName @guest.Surname
                            <span class="guest-number-badge">(@guest.GuestNumber)</span>
                        </h2>
                        <div class="guest-status">
                            @if (guest.IsSecondTimer)
                            {
                                <span class="badge bg-warning me-2">Second Timer</span>
                            }
                            else
                            {
                                <span class="badge bg-success me-2">First Timer</span>
                            }
                            <span class="text-muted">
                                <i class="fas fa-calendar me-1"></i>
                                Visiting Date: @guest.VisitingDate.ToString("dd MMM yyyy")
                            </span>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary btn-sm" @onclick="GoBack">
                            <i class="fas fa-arrow-left me-1"></i>Back
                        </button>
                        <a href="@($"/guest/edit/{Id}")" class="btn btn-warning btn-sm">
                            <i class="fas fa-edit me-1"></i>Edit
                        </a>
                        <button class="btn btn-danger btn-sm" @onclick="DeleteGuest">
                            <i class="fas fa-trash me-1"></i>Delete
                        </button>
                    </div>
                </div>
            </div>

            <!-- Row 1: Personal & Contact Information Side by Side -->
            <div class="row g-3 mb-4">
                <!-- Personal Information Card -->
                <div class="col-lg-6">
                    <div class="card shadow-sm h-100 border-0">
                        <div class="card-header personal-header">
                            <h6 class="mb-0">
                                <i class="fas fa-user-circle me-2"></i>Personal Information
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-6">
                                    <div class="info-item">
                                        <small class="text-muted">Title</small>
                                        <div class="fw-semibold">@guest.Title</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="info-item">
                                        <small class="text-muted">Full Name</small>
                                        <div class="fw-semibold">@guest.FirstName @guest.MiddleName @guest.Surname</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="info-item">
                                        <small class="text-muted">Sex</small>
                                        <div class="fw-semibold">@guest.Sex</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="info-item">
                                        <small class="text-muted">Age Group</small>
                                        <div class="fw-semibold">@guest.AgeGroup</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Information Card -->
                <div class="col-lg-6">
                    <div class="card shadow-sm h-100 border-0">
                        <div class="card-header contact-header">
                            <h6 class="mb-0">
                                <i class="fas fa-address-book me-2"></i>Contact Information
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-2">
                                @if (!string.IsNullOrEmpty(guest.Address))
                                {
                                    <div class="col-12">
                                        <div class="info-item">
                                            <small class="text-muted">Address</small>
                                            <div class="fw-semibold">@guest.Address</div>
                                        </div>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(guest.Landmark))
                                {
                                    <div class="col-12">
                                        <div class="info-item">
                                            <small class="text-muted">Landmark</small>
                                            <div class="fw-semibold">@guest.Landmark</div>
                                        </div>
                                    </div>
                                }
                                <div class="col-12">
                                    <div class="row g-2">
                                        @if (!string.IsNullOrEmpty(guest.PhoneNumber))
                                        {
                                            <div class="col-6">
                                                <div class="info-item">
                                                    <small class="text-muted">Phone</small>
                                                    <div class="fw-semibold">@guest.PhoneNumber</div>
                                                </div>
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(guest.WhatsAppNumber))
                                        {
                                            <div class="col-6">
                                                <div class="info-item">
                                                    <small class="text-muted">WhatsApp</small>
                                                    <div class="fw-semibold">@guest.WhatsAppNumber</div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                                @if (!string.IsNullOrEmpty(guest.Email))
                                {
                                    <div class="col-12">
                                        <div class="info-item">
                                            <small class="text-muted">Email</small>
                                            <div class="fw-semibold">@guest.Email</div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row 2: Church & Service Information Side by Side -->
            <div class="row g-3">
                <!-- Church Information Card -->
                <div class="col-lg-6">
                    <div class="card shadow-sm h-100 border-0">
                        <div class="card-header church-header">
                            <h6 class="mb-0">
                                <i class="fas fa-church me-2"></i>Church Information
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-6">
                                    <div class="info-item">
                                        <small class="text-muted">RCCG Member</small>
                                        <div>
                                            @if (guest.IsRCCGMember)
                                            {
                                                <span class="badge bg-success">Yes</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">No</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                                @if (!guest.IsRCCGMember && !string.IsNullOrEmpty(guest.OtherChurch))
                                {
                                    <div class="col-6">
                                        <div class="info-item">
                                            <small class="text-muted">Other Church</small>
                                            <div class="fw-semibold">@guest.OtherChurch</div>
                                        </div>
                                    </div>
                                }
                                <div class="col-6">
                                    <div class="info-item">
                                        <small class="text-muted">How Found Us</small>
                                        <div class="fw-semibold">@guest.HowFoundUs</div>
                                    </div>
                                </div>
                                @if (guest.HowFoundUs == "invite" && !string.IsNullOrEmpty(guest.InvitedByName))
                                {
                                    <div class="col-6">
                                        <div class="info-item">
                                            <small class="text-muted">Invited By</small>
                                            <div class="fw-semibold">@guest.InvitedByName</div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Service Information Card -->
                <div class="col-lg-6">
                    <div class="card shadow-sm h-100 border-0">
                        <div class="card-header service-header">
                            <h6 class="mb-0">
                                <i class="fas fa-calendar-alt me-2"></i>Service Information
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-6">
                                    <div class="info-item">
                                        <small class="text-muted">Service</small>
                                        <div class="fw-semibold">@guest.Service?.Name</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="info-item">
                                        <small class="text-muted">Visiting Date</small>
                                        <div class="fw-semibold">@guest.VisitingDate.ToString("dd/MM/yyyy")</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="info-item">
                                        <small class="text-muted">Recording Date</small>
                                        <div class="fw-semibold">@guest.RecordingDate.ToString("dd/MM/yyyy")</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="info-item">
                                        <small class="text-muted">Recorded By</small>
                                        <div class="fw-semibold">@guest.RecordedByName</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons Footer -->
            <div class="card shadow-sm border-0 mt-4">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Guest ID: <strong>@guest.GuestNumber</strong>
                                <span class="ms-3">
                                    Created: @guest.CreatedDate.ToString("dd/MM/yyyy HH:mm")
                                    @if (guest.UpdatedDate.HasValue)
                                    {
                                        <span class="ms-2">| Updated: @guest.UpdatedDate.Value.ToString("dd/MM/yyyy HH:mm")</span>
                                    }
                                </span>
                            </small>
                        </div>
                        <div class="d-flex gap-2">
                            @if (!guest.IsSecondTimer)
                            {
                                <button class="btn btn-outline-success btn-sm" @onclick="MarkAsSecondTimer">
                                    <i class="fas fa-user-check me-1"></i>Mark as Second Timer
                                </button>
                            }
                            <button class="btn btn-outline-primary btn-sm" onclick="window.print()">
                                <i class="fas fa-print me-1"></i>Print
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
}
else
{
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">Authentication Required</h5>
                    </div>
                    <div class="card-body text-center py-4">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <h4>Please Log In</h4>
                        <p class="text-muted">You need to be logged in to access this page.</p>
                        <a href="/login" class="btn btn-primary mt-2">Go to Login</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteModal)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>Confirm Delete
                    </h5>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this guest record?</p>
                    <div class="alert alert-warning mb-3">
                        <strong>Guest:</strong> @guest?.Title @guest?.FirstName @guest?.Surname<br>
                        <strong>Guest ID:</strong> @guest?.GuestNumber
                    </div>
                    <p class="text-danger small mb-0">
                        <i class="fas fa-exclamation-circle me-1"></i>This action cannot be undone.
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelDelete">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-danger" @onclick="ConfirmDelete" disabled="@isDeleting">
                        @if (isDeleting)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        else
                        {
                            <i class="fas fa-trash me-1"></i>
                        }
                        Delete Guest
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int Id { get; set; }

    private Guest? guest;
    private bool isLoading = true;
    private bool isDeleting = false;
    private string errorMessage = "";
    private string successMessage = "";
    private bool showDeleteModal = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadGuestDetails();
    }

    private async Task LoadGuestDetails()
    {
        try
        {
            guest = await GuestService.GetGuestByIdAsync(Id);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading guest details: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private bool IsFIGDirectorateMember()
    {
        var worker = AuthService.CurrentWorker;
        if (worker == null) return false;

        var directorateName = worker.Directorate?.Name?.ToLowerInvariant() ?? "";
        var role = worker.Role?.ToLowerInvariant() ?? "";

        var isInFIG = directorateName.Contains("fig");
        var hasValidRole = role.Contains("head of directorate") ||
                          role.Contains("asst head of directorate") ||
                          role.Contains("directorate member") ||
                          AuthService.IsInRole("Church Admin") ||
                          AuthService.IsInRole("Pastor in Charge");

        return isInFIG && hasValidRole;
    }

    private void DeleteGuest()
    {
        showDeleteModal = true;
        StateHasChanged();
    }

    private async Task ConfirmDelete()
    {
        isDeleting = true;
        try
        {
            var success = await GuestService.DeleteGuestAsync(Id);

            if (success)
            {
                successMessage = $"Guest {guest?.GuestNumber} deleted successfully.";
                showDeleteModal = false;

                // Redirect after 2 seconds
                await Task.Delay(2000);
                Navigation.NavigateTo("/guest/first-timer");
            }
            else
            {
                errorMessage = "Failed to delete guest. Please try again.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting guest: {ex.Message}";
        }
        finally
        {
            isDeleting = false;
            StateHasChanged();
        }
    }

    private void CancelDelete()
    {
        showDeleteModal = false;
        StateHasChanged();
    }

    private async Task MarkAsSecondTimer()
    {
        successMessage = "Marking as second timer feature coming soon!";
        StateHasChanged();
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/guest/first-timer");
    }

    private void ClearSuccessMessage()
    {
        successMessage = "";
        StateHasChanged();
    }

    private void ClearErrorMessage()
    {
        errorMessage = "";
        StateHasChanged();
    }
}

<style>
    /* Main Header - Very Bold */
    .main-header h2 {
        font-size: 1.8rem;
        font-weight: 700 !important;
        color: #2c3e50;
        margin-bottom: 0.5rem;
    }

    .guest-number-badge {
        font-size: 1.2rem;
        color: #17a2b8;
        font-weight: 700;
        background: rgba(23, 162, 184, 0.1);
        padding: 0.2rem 0.6rem;
        border-radius: 6px;
        margin-left: 0.5rem;
    }

    .guest-status {
        margin-top: 0.25rem;
    }

        .guest-status .badge {
            font-size: 0.75rem;
            padding: 0.35em 0.65em;
        }

        .guest-status .text-muted {
            font-size: 0.85rem;
        }

    /* Compact Card Design */
    .card {
        border-radius: 8px;
        overflow: hidden;
    }

    /* Card Header Styling */
    .card-header {
        padding: 0.75rem 1rem;
        font-weight: 600;
        font-size: 0.85rem;
        color: white;
        border-bottom: none;
    }

    .personal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .contact-header {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .church-header {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .service-header {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }

    /* Card Body */
    .card-body {
        padding: 1rem;
    }

    /* Info Item Styling */
    .info-item {
        margin-bottom: 0.75rem;
    }

        .info-item:last-child {
            margin-bottom: 0;
        }

        .info-item small {
            font-size: 0.7rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            display: block;
            margin-bottom: 2px;
        }

        .info-item .fw-semibold {
            color: #2d3748;
            font-size: 0.85rem;
            line-height: 1.2;
        }

    /* Badge Styling */
    .badge {
        padding: 0.25em 0.5em;
        font-size: 0.65em;
        font-weight: 500;
    }

    /* Button Styling */
    .btn-sm {
        padding: 0.2rem 0.5rem;
        font-size: 0.75rem;
        border-radius: 4px;
    }

    /* Layout Spacing */
    .row.g-3 {
        --bs-gutter-x: 1rem;
        --bs-gutter-y: 1rem;
    }

    .row.g-2 {
        --bs-gutter-x: 0.75rem;
        --bs-gutter-y: 0.75rem;
    }

    /* Equal Height Cards */
    .h-100 {
        height: 100%;
    }

    /* Responsive Adjustments */
    @@media (max-width: 768px) {
        .main-header h2 {
            font-size: 1.4rem;
        }

        .guest-number-badge {
            font-size: 1rem;
            padding: 0.15rem 0.4rem;
        }

        .card-header {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
        }

        .card-body {
            padding: 0.75rem;
        }

        .info-item small {
            font-size: 0.65rem;
        }

        .info-item .fw-semibold {
            font-size: 0.8rem;
        }

        .btn-sm {
            padding: 0.15rem 0.4rem;
            font-size: 0.7rem;
        }

        .row.g-3 {
            --bs-gutter-x: 0.75rem;
            --bs-gutter-y: 0.75rem;
        }

        .row.g-2 {
            --bs-gutter-x: 0.5rem;
            --bs-gutter-y: 0.5rem;
        }

        .guest-status {
            flex-direction: column;
            align-items: flex-start;
        }

            .guest-status .badge {
                margin-bottom: 0.25rem;
            }
    }

    /* Print Styles */
    @@media print {
        .btn, .card-footer {
            display: none !important;
        }

        .card-header {
            background: #f8f9fa !important;
            color: #2d3748 !important;
            border-bottom: 2px solid #dee2e6;
        }

        .main-header h2 {
            font-size: 1.5rem;
            color: #000 !important;
        }

        .guest-number-badge {
            color: #000 !important;
            background: none !important;
        }
    }
</style>
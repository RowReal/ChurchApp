@page "/guest"
@layout Components.Layout.MainLayout
@using ChurchApp.Services
@using ChurchApp.Models
@inject GuestService GuestService
@inject AuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Guest Management - BCC ServiceHub</PageTitle>

@if (AuthService.IsAuthenticated)
{
    <div class="container-fluid py-4">
        <!-- Authorization Check -->
        @if (!IsFIGDirectorateMember())
        {
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Access Restricted</h5>
                        </div>
                        <div class="card-body text-center">
                            <i class="fas fa-lock fa-3x text-warning mb-3"></i>
                            <h4>Access Denied</h4>
                            <p class="text-muted">This section is only accessible to FIG Directorate members.</p>
                            <a href="/" class="btn btn-primary">
                                <i class="fas fa-home me-1"></i>Return to Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="row">
                <div class="col-lg-10 mx-auto">
                    <div class="card">
                        <div class="card-header bg-dark-blue text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-users me-2"></i>Guest Management Dashboard
                                </h5>
                                <span class="badge bg-info">FIG Directorate Only</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Quick Stats Row -->
                            <div class="row mb-5">
                                <div class="col-md-3">
                                    <div class="card text-white bg-primary">
                                        <div class="card-body text-center py-3">
                                            <h3>@stats?.TotalGuests ?? 0</h3>
                                            <p class="mb-0">Total Guests</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-white bg-info">
                                        <div class="card-body text-center py-3">
                                            <h3>@stats?.FirstTimers ?? 0</h3>
                                            <p class="mb-0">First Timers</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-white bg-success">
                                        <div class="card-body text-center py-3">
                                            <h3>@stats?.SecondTimers ?? 0</h3>
                                            <p class="mb-0">Second Timers</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-white bg-warning">
                                        <div class="card-body text-center py-3">
                                            <h3>@(stats?.ConversionRate.ToString("0.0") ?? "0.0")%</h3>
                                            <p class="mb-0">Conversion Rate</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Main Action Cards -->
                            <div class="row g-4">
                                <!-- Record First Timer Card -->
                                <div class="col-md-6">
                                    <div class="card h-100 border-primary hover-shadow">
                                        <div class="card-body text-center">
                                            <div class="mb-3">
                                                <i class="fas fa-user-plus fa-3x text-primary"></i>
                                            </div>
                                            <h5 class="card-title">Record First Timer</h5>
                                            <p class="card-text text-muted">
                                                Capture information for new guests visiting for the first time.
                                            </p>
                                            <div class="mt-3">
                                                <a href="/guest/first-timer" class="btn btn-primary w-100">
                                                    <i class="fas fa-plus-circle me-2"></i>Start Recording
                                                </a>
                                            </div>
                                        </div>
                                        <div class="card-footer bg-light">
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Records 14 information points for new guests
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Record Second Timer Card -->
                                <div class="col-md-6">
                                    <div class="card h-100 border-success hover-shadow">
                                        <div class="card-body text-center">
                                            <div class="mb-3">
                                                <i class="fas fa-user-check fa-3x text-success"></i>
                                            </div>
                                            <h5 class="card-title">Record Second Timer</h5>
                                            <p class="card-text text-muted">
                                                Update information for guests visiting for the second time.
                                            </p>
                                            <div class="mt-3">
                                                <a href="/guest/second-timer" class="btn btn-success w-100">
                                                    <i class="fas fa-sync-alt me-2"></i>Search & Update
                                                </a>
                                            </div>
                                        </div>
                                        <div class="card-footer bg-light">
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Search first timers and mark as second visit
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- View Daily List Card -->
                                <div class="col-md-6">
                                    <div class="card h-100 border-info hover-shadow">
                                        <div class="card-body text-center">
                                            <div class="mb-3">
                                                <i class="fas fa-list-alt fa-3x text-info"></i>
                                            </div>
                                            <h5 class="card-title">Daily Guest List</h5>
                                            <p class="card-text text-muted">
                                                View all guests recorded for today. Updates automatically.
                                            </p>
                                            <div class="mt-3">
                                                <a href="/guest/daily-list" class="btn btn-info w-100">
                                                    <i class="fas fa-eye me-2"></i>View Today's List
                                                </a>
                                            </div>
                                        </div>
                                        <div class="card-footer bg-light">
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Filter by date and see recording statistics
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Search Guests Card -->
                                <div class="col-md-6">
                                    <div class="card h-100 border-warning hover-shadow">
                                        <div class="card-body text-center">
                                            <div class="mb-3">
                                                <i class="fas fa-search fa-3x text-warning"></i>
                                            </div>
                                            <h5 class="card-title">Search All Guests</h5>
                                            <p class="card-text text-muted">
                                                Search through all guest records with advanced filters.
                                            </p>
                                            <div class="mt-3">
                                                <a href="/guest/search" class="btn btn-warning w-100">
                                                    <i class="fas fa-search me-2"></i>Advanced Search
                                                </a>
                                            </div>
                                        </div>
                                        <div class="card-footer bg-light">
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Search by date, guest number, name, or phone
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Links Section -->
                            <div class="row mt-5">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row g-2">
                                                <div class="col-md-3">
                                                    <a href="/guest/first-timer" class="btn btn-outline-primary w-100">
                                                        <i class="fas fa-user-plus me-1"></i>New Guest
                                                    </a>
                                                </div>
                                                <div class="col-md-3">
                                                    <a href="/guest/daily-list" class="btn btn-outline-info w-100">
                                                        <i class="fas fa-calendar-day me-1"></i>Today's List
                                                    </a>
                                                </div>
                                                <div class="col-md-3">
                                                    <a href="/guest/second-timer" class="btn btn-outline-success w-100">
                                                        <i class="fas fa-user-check me-1"></i>Second Timer
                                                    </a>
                                                </div>
                                                <div class="col-md-3">
                                                    <a href="/" class="btn btn-outline-secondary w-100">
                                                        <i class="fas fa-home me-1"></i>Dashboard
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>
                                        Last updated: @DateTime.Now.ToString("h:mm tt")
                                    </small>
                                </div>
                                <div>
                                    <small class="text-muted">
                                        <i class="fas fa-user-shield me-1"></i>
                                        Logged in as: @AuthService.CurrentWorker?.FirstName @AuthService.CurrentWorker?.LastName
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}
else
{
    <!-- Authentication Required -->
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">Authentication Required</h5>
                    </div>
                    <div class="card-body text-center">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <h4>Please Log In</h4>
                        <p class="text-muted">You need to be logged in to access this page.</p>
                        <a href="/login" class="btn btn-primary">Go to Login</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private GuestStatistics stats;

    protected override async Task OnInitializedAsync()
    {
        if (IsFIGDirectorateMember())
        {
            await LoadStatistics();
        }
    }

    private async Task LoadStatistics()
    {
        try
        {
            stats = await GuestService.GetGuestStatisticsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading statistics: {ex.Message}");
        }
    }

    private bool IsFIGDirectorateMember()
    {
        var worker = AuthService.CurrentWorker;
        if (worker == null) return false;

        var directorateName = worker.Directorate?.Name?.ToLowerInvariant() ?? "";
        var role = worker.Role?.ToLowerInvariant() ?? "";

        // Check if worker is in FIG Directorate
        var isInFIG = directorateName.Contains("fig");

        // Check if worker has appropriate role
        var hasValidRole = AuthService.IsInRole("Church Admin") ||
                            AuthService.IsInRole("Head of Service")||
                          AuthService.IsInRole("Pastor in Charge");

        return isInFIG || hasValidRole;
    }
}

<style>
    .hover-shadow:hover {
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.15) !important;
        transform: translateY(-2px);
        transition: all 0.3s ease;
    }

    .bg-dark-blue {
        background-color: #2c3e50;
    }

    .card {
        transition: transform 0.2s;
    }

        .card:hover {
            transform: translateY(-3px);
        }

    .btn {
        transition: all 0.2s;
    }

        .btn:hover {
            transform: translateY(-1px);
        }
</style>

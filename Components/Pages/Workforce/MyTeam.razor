@page "/workforce/my-team"
@layout Components.Layout.MainLayout
@using ChurchApp.Services
@using ChurchApp.Models
@inject WorkerService WorkerService
@inject AuthService AuthService
@inject NavigationManager Navigation

<PageTitle>My Team - Workforce</PageTitle>

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h2>My Team</h2>
            <p class="text-muted">View team members under your supervision</p>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Search</label>
                        <input type="text" class="form-control" placeholder="Search by name, worker ID..." 
                               @bind-value="searchText" @bind-value:event="oninput" />
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label">Directorate</label>
                        <select class="form-select" @bind="selectedDirectorate">
                            <option value="">All Directorates</option>
                            @foreach (var dir in directorates)
                            {
                                <option value="@dir">@dir</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label">Department</label>
                        <select class="form-select" @bind="selectedDepartment">
                            <option value="">All Departments</option>
                            @foreach (var dept in departments)
                            {
                                <option value="@dept">@dept</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="mb-3">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-outline-secondary w-100" @onclick="ClearFilters">
                            <i class="fas fa-filter-circle-xmark me-2"></i>Clear Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Members List -->
    <div class="card">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Team Members (@filteredWorkers.Count)</h5>
            <div>
                <span class="badge bg-light text-dark me-2">
                    <i class="fas fa-users me-1"></i>Total: @workers.Count
                </span>
            </div>
        </div>
        <div class="card-body p-0">
            @if (isLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading team members...</p>
                </div>
            }
            else if (filteredWorkers.Count == 0)
            {
                <div class="text-center py-5">
                    <i class="fas fa-users-slash fa-3x text-muted mb-3"></i>
                    <h4>No Team Members Found</h4>
                    <p class="text-muted">@(workers.Count == 0 ? "No team members are assigned to you." : "No workers match your search criteria.")</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Photo</th>
                                <th>Worker ID</th>
                                <th>Name</th>
                                <th>Directorate</th>
                                <th>Department</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var worker in filteredWorkers)
                            {
                                <tr>
                                    <td>
                                        @if (!string.IsNullOrEmpty(worker.PassportPhotoPath))
                                        {
                                            <img src="/uploads/@worker.PassportPhotoPath" 
                                                 alt="@worker.FirstName" 
                                                 class="rounded-circle"
                                                 style="width: 40px; height: 40px; object-fit: cover;" />
                                        }
                                        else
                                        {
                                            <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center"
                                                 style="width: 40px; height: 40px;">
                                                <i class="fas fa-user text-white"></i>
                                            </div>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge bg-info">@worker.WorkerId</span>
                                    </td>
                                    <td>
                                        <strong>@worker.FirstName @worker.LastName</strong>
                                        @if (!string.IsNullOrEmpty(worker.MiddleName))
                                        {
                                            <br/><small class="text-muted">@worker.MiddleName</small>
                                        }
                                    </td>
                                    <td>
                                        @if (worker.Directorate != null)
                                        {
                                            <span class="badge bg-primary">@worker.Directorate.Name</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">Not assigned</span>
                                        }
                                    </td>
                                    <td>
                                        @if (worker.Department != null)
                                        {
                                            <span class="badge bg-info">@worker.Department.Name</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">Not assigned</span>
                                        }
                                    </td>
                                    <td>
                                        <small>@worker.Role</small>
                                    </td>
                                    <td>
                                        <span class="badge @(worker.IsActive ? "bg-success" : "bg-secondary")">
                                            @(worker.IsActive ? "Active" : "Inactive")
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" 
                                                @onclick="() => ViewWorkerDetails(worker.Id)"
                                                title="View Details">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                @if (totalPages > 1)
                {
                    <div class="card-footer">
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-center mb-0">
                                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                    <button class="page-link" @onclick="() => ChangePage(currentPage - 1)">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                </li>
                                
                                @for (int i = 1; i <= totalPages; i++)
                                {
                                    if (i == 1 || i == totalPages || (i >= currentPage - 2 && i <= currentPage + 2))
                                    {
                                        <li class="page-item @(i == currentPage ? "active" : "")">
                                            <button class="page-link" @onclick="() => ChangePage(i)">@i</button>
                                        </li>
                                    }
                                    else if (i == currentPage - 3 || i == currentPage + 3)
                                    {
                                        <li class="page-item disabled">
                                            <span class="page-link">...</span>
                                        </li>
                                    }
                                }
                                
                                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                    <button class="page-link" @onclick="() => ChangePage(currentPage + 1)">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </li>
                            </ul>
                        </nav>
                    </div>
                }
            }
        </div>
    </div>
</div>

@code {
    private List<Worker> workers = new List<Worker>();
    private List<Worker> filteredWorkers = new List<Worker>();
    private bool isLoading = true;
    
    // Filters
    private string searchText = "";
    private string selectedDirectorate = "";
    private string selectedDepartment = "";
    
    // Pagination
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 1;
    
    // Filter options
    private List<string> directorates = new List<string>();
    private List<string> departments = new List<string>();
    
    protected override async Task OnInitializedAsync()
    {
        if (!CanAccessMyTeam())
        {
            Navigation.NavigateTo("/");
            return;
        }
        
        await LoadTeamMembers();
    }
    
    private async Task LoadTeamMembers()
    {
        try
        {
            isLoading = true;
            StateHasChanged();
            
            var currentWorker = AuthService.CurrentWorker;
            if (currentWorker == null) return;
            
            // Get workers based on role
            if (currentWorker.Role?.Contains("Pastor in Charge") == true || 
                currentWorker.Role?.Contains("Head of Service") == true)
            {
                // Get all workers
                workers = await WorkerService.GetAllWorkersAsync();
            }
            else if (currentWorker.Role?.Contains("Head of Directorate") == true || 
                     currentWorker.Role?.Contains("Asst Head of Directorate") == true)
            {
                // Get workers in same directorate
                if (currentWorker.DirectorateId.HasValue)
                {
                    workers = await WorkerService.GetWorkersByDirectorateAsync(currentWorker.DirectorateId.Value);
                }
                else
                {
                    workers = new List<Worker>();
                }
            }
            else
            {
                workers = new List<Worker>();
            }
            
            // Extract filter options
            ExtractFilterOptions();
            
            // Apply initial filtering
            ApplyFilters();
            
            isLoading = false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading team members: {ex.Message}");
            workers = new List<Worker>();
            isLoading = false;
        }
    }
    
    private void ExtractFilterOptions()
    {
        directorates = workers
            .Where(w => w.Directorate != null)
            .Select(w => w.Directorate.Name)
            .Distinct()
            .OrderBy(d => d)
            .ToList();
            
        departments = workers
            .Where(w => w.Department != null)
            .Select(w => w.Department.Name)
            .Distinct()
            .OrderBy(d => d)
            .ToList();
    }
    
    private void ApplyFilters()
    {
        var filtered = workers.AsEnumerable();
        
        // Apply search filter
        if (!string.IsNullOrWhiteSpace(searchText))
        {
            var search = searchText.ToLowerInvariant();
            filtered = filtered.Where(w =>
                (w.FirstName?.ToLowerInvariant().Contains(search) == true) ||
                (w.LastName?.ToLowerInvariant().Contains(search) == true) ||
                (w.MiddleName?.ToLowerInvariant().Contains(search) == true) ||
                (w.WorkerId?.ToLowerInvariant().Contains(search) == true));
        }
        
        // Apply directorate filter
        if (!string.IsNullOrWhiteSpace(selectedDirectorate))
        {
            filtered = filtered.Where(w => 
                w.Directorate != null && 
                w.Directorate.Name == selectedDirectorate);
        }
        
        // Apply department filter
        if (!string.IsNullOrWhiteSpace(selectedDepartment))
        {
            filtered = filtered.Where(w => 
                w.Department != null && 
                w.Department.Name == selectedDepartment);
        }
        
        filteredWorkers = filtered.ToList();
        
        // Calculate pagination
        totalPages = (int)Math.Ceiling(filteredWorkers.Count / (double)pageSize);
        if (currentPage > totalPages && totalPages > 0)
            currentPage = totalPages;
        
        // Apply pagination
        filteredWorkers = filteredWorkers
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
        
        StateHasChanged();
    }
    
    private void ClearFilters()
    {
        searchText = "";
        selectedDirectorate = "";
        selectedDepartment = "";
        currentPage = 1;
        ApplyFilters();
    }
    
    private void ChangePage(int page)
    {
        if (page < 1 || page > totalPages) return;
        
        currentPage = page;
        ApplyFilters();
    }
    
    private void ViewWorkerDetails(int workerId)
    {
        Navigation.NavigateTo($"/workforce/worker-details/{workerId}");
    }
    
    private bool CanAccessMyTeam()
    {
        var worker = AuthService.CurrentWorker;
        if (worker == null) return false;
        
        var role = worker.Role?.ToLowerInvariant() ?? "";
        
        return role.Contains("head of directorate") ||
               role.Contains("asst head of directorate") ||
               role.Contains("head of service") ||
               role.Contains("pastor in charge") ||
               role.Contains("senior pastor");
    }
}
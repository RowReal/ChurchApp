@page "/Offering/list"
@using ChurchApp.Models
@using ChurchApp.Services
@implements IDisposable
@inject RecordNominationService RecordNominationService
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Record Nominations List</PageTitle>

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-list-check me-2"></i> Record Nominations List
                    </h4>
                    <div>
                        <a href="/Offering/record-nomination" class="btn btn-light btn-sm me-2">
                            <i class="fas fa-plus-circle me-1"></i> New Nomination
                        </a>
                        <button class="btn btn-light btn-sm" @onclick="RefreshData">
                            <i class="fas fa-sync-alt me-1"></i> Refresh
                        </button>
                    </div>
                </div>
                
                <div class="card-body">
                    @if (!canNominate)
                    {
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i> 
                            You are not authorized to view nominations. 
                            Only Head of FIG Directorate or Assistant Head of FIG Directorate can access this feature.
                        </div>
                    }
                    else if (isLoading)
                    {
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3 text-muted">Loading nominations...</p>
                        </div>
                    }
                    else if (nominations.Count == 0)
                    {
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> 
                            No nominations found. 
                            <a href="/Offering/record-nomination" class="alert-link">Click here to create a nomination</a>.
                        </div>
                    }
                    else
                    {
                        <!-- Filters Section -->
                        <div class="row mb-4">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-church me-1"></i> Service
                                </label>
                                <select class="form-select" @onchange="OnServiceSelected">
                                    <option value="0">All Services</option>
                                    @foreach (var service in services)
                                    {
                                        <option value="@service.Id" selected="@(selectedServiceId == service.Id)">
                                            @service.Name
                                        </option>
                                    }
                                </select>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-calendar me-1"></i> Date From
                                </label>
                                <input type="date" class="form-control" 
                                       @onchange="OnDateFromChanged"
                                       value="@(filterDateFrom?.ToString("yyyy-MM-dd") ?? "")" />
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-calendar me-1"></i> Date To
                                </label>
                                <input type="date" class="form-control" 
                                       @onchange="OnDateToChanged"
                                       value="@(filterDateTo?.ToString("yyyy-MM-dd") ?? "")" />
                            </div>
                        </div>

                        <!-- Summary Cards -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-0">Total Nominations</h6>
                                                <h4 class="mb-0 mt-2">@filteredNominations.Count</h4>
                                            </div>
                                            <i class="fas fa-list-check fa-2x opacity-50"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-9">
                                <div class="card">
                                    <div class="card-body p-3">
                                        <h6 class="mb-3">Nominations by Record Type</h6>
                                        <div class="d-flex flex-wrap gap-2">
                                            @foreach (var typeGroup in GetRecordTypeCounts())
                                            {
                                                <span class="badge @GetRecordTypeBadgeClass(typeGroup.Key) p-2">
                                                    @GetRecordTypeDisplay(typeGroup.Key): @typeGroup.Count()
                                                </span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Success/Error Messages -->
                        @if (!string.IsNullOrEmpty(successMessage))
                        {
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                <i class="fas fa-check-circle me-2"></i> @successMessage
                                <button type="button" class="btn-close" @onclick="ClearSuccessMessage"></button>
                            </div>
                        }
                        
                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <i class="fas fa-exclamation-circle me-2"></i> @errorMessage
                                <button type="button" class="btn-close" @onclick="ClearErrorMessage"></button>
                            </div>
                        }

                        <!-- Nominations Table -->
                        <div class="table-responsive">
                            <table class="table table-hover table-striped">
                                <thead class="table-light">
                                    <tr>
                                        <th width="20%">Service</th>
                                        <th width="10%">Date</th>
                                        <th width="20%">Nominee</th>
                                        <th width="15%">Record Type</th>
                                        <th width="20%">Nominated By</th>
                                        <th width="10%">Nominated On</th>
                                        <th width="5%" class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (filteredNominations.Count == 0)
                                    {
                                        <tr>
                                            <td colspan="7" class="text-center py-4">
                                                <div class="text-muted">
                                                    <i class="fas fa-search fa-2x mb-3"></i>
                                                    <p>No nominations match your filters</p>
                                                    <button class="btn btn-sm btn-outline-primary" @onclick="ClearFilters">
                                                        <i class="fas fa-times me-1"></i> Clear Filters
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                    else
                                    {
                                        @foreach (var nomination in filteredNominations.Skip((currentPage - 1) * pageSize).Take(pageSize))
                                        {
                                            <tr>
                                                <td>
                                                    <div class="fw-bold">@nomination.ServiceName</div>
                                                    @if (!string.IsNullOrEmpty(nomination.ServiceDescription))
                                                    {
                                                        <small class="text-muted">@nomination.ServiceDescription</small>
                                                    }
                                                </td>
                                                <td>
                                                    <span class="badge bg-info text-dark">
                                                        @nomination.ServiceDate.ToString("ddd, MMM dd")
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="me-2">
                                                            <i class="fas fa-user-circle text-primary"></i>
                                                        </div>
                                                        <div>
                                                            <div class="fw-bold">
                                                                @GetLastNameFirst(nomination.NomineeName)
                                                            </div>
                                                            <small class="text-muted">@nomination.NomineeWorkerId</small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="badge @GetRecordTypeBadgeClass(nomination.RecordType) p-2">
                                                        <i class="@GetRecordTypeIcon(nomination.RecordType) me-1"></i>
                                                        @nomination.RecordTypeDisplay
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="me-2">
                                                            <i class="fas fa-user-tie text-secondary"></i>
                                                        </div>
                                                        <div>
                                                            <div class="fw-bold">
                                                                @GetLastNameFirst(nomination.NominatorName)
                                                            </div>
                                                            <small class="text-muted">@nomination.NominatorWorkerId</small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    @nomination.CreatedDate.ToString("MMM dd")
                                                    <br/>
                                                    <small class="text-muted">@nomination.CreatedDate.ToString("hh:mm tt")</small>
                                                </td>
                                                <td class="text-center">
                                                    <button class="btn btn-sm btn-outline-danger" 
                                                            @onclick="() => DeleteNomination(nomination.Id)"
                                                            title="Delete Nomination (Permanent)"
                                                            disabled="@(isDeleting.Contains(nomination.Id))">
                                                        @if (isDeleting.Contains(nomination.Id))
                                                        {
                                                            <span class="spinner-border spinner-border-sm" role="status"></span>
                                                        }
                                                        else
                                                        {
                                                            <i class="fas fa-trash"></i>
                                                        }
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        @if (filteredNominations.Count > pageSize)
                        {
                            <div class="d-flex justify-content-between align-items-center mt-4">
                                <div class="text-muted">
                                    Showing @((currentPage - 1) * pageSize + 1) to @Math.Min(currentPage * pageSize, filteredNominations.Count) 
                                    of @filteredNominations.Count nominations
                                </div>
                                
                                <nav aria-label="Page navigation">
                                    <ul class="pagination justify-content-center mb-0">
                                        <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                            <button class="page-link" @onclick="() => ChangePage(currentPage - 1)" 
                                                    disabled="@(currentPage == 1)">
                                                <i class="fas fa-chevron-left"></i>
                                            </button>
                                        </li>
                                        
                                        @for (int i = 1; i <= totalPages; i++)
                                        {
                                            if (i == 1 || i == totalPages || (i >= currentPage - 2 && i <= currentPage + 2))
                                            {
                                                <li class="page-item @(i == currentPage ? "active" : "")">
                                                    <button class="page-link" @onclick="() => ChangePage(i)">@i</button>
                                                </li>
                                            }
                                            else if (i == currentPage - 3 || i == currentPage + 3)
                                            {
                                                <li class="page-item disabled">
                                                    <span class="page-link">...</span>
                                                </li>
                                            }
                                        }
                                        
                                        <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                            <button class="page-link" @onclick="() => ChangePage(currentPage + 1)"
                                                    disabled="@(currentPage == totalPages)">
                                                <i class="fas fa-chevron-right"></i>
                                            </button>
                                        </li>
                                    </ul>
                                </nav>
                                
                                <div>
                                    <select class="form-select form-select-sm w-auto d-inline" 
                                            @onchange="OnPageSizeChanged">
                                        <option value="10" selected="@(pageSize == 10)">10 per page</option>
                                        <option value="25" selected="@(pageSize == 25)">25 per page</option>
                                        <option value="50" selected="@(pageSize == 50)">50 per page</option>
                                        <option value="100" selected="@(pageSize == 100)">100 per page</option>
                                    </select>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private List<RecordNominationDTO> nominations = new();
    private List<RecordNominationDTO> filteredNominations = new();
    private List<Service> services = new();
    private HashSet<int> isDeleting = new(); // Changed from isDeactivating to isDeleting
    private bool canNominate = false;
    private bool isLoading = true;
    private int selectedServiceId = 0;
    private DateTime? filterDateFrom;
    private DateTime? filterDateTo;
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 1;
    private CancellationTokenSource? _cancellationTokenSource;
    private string? errorMessage;
    private string? successMessage;

    protected override async Task OnInitializedAsync()
    {
        if (AuthService.CurrentWorker == null)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        canNominate = await RecordNominationService.CanNominateRecords(AuthService.CurrentWorker.WorkerId);
        
        if (canNominate)
        {
            await LoadData();
        }
        else
        {
            isLoading = false;
        }
    }

    private async Task LoadData()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            StateHasChanged();
            
            // Load services first
            services = await RecordNominationService.GetServicesForNomination();
            
            // Load nominations using DTO
            nominations = await RecordNominationService.GetAllNominationsDTO();
            
            // Apply initial filtering
            ApplyFilters();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading nominations: {ex.Message}";
            await ShowError(errorMessage);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnServiceSelected(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int serviceId))
        {
            selectedServiceId = serviceId;
            currentPage = 1; // Reset to first page
            await ApplyFiltersAsync();
        }
    }

    private async Task OnDateFromChanged(ChangeEventArgs e)
    {
        if (!string.IsNullOrEmpty(e.Value?.ToString()))
        {
            if (DateTime.TryParse(e.Value.ToString(), out DateTime date))
            {
                filterDateFrom = date.Date;
            }
            else
            {
                filterDateFrom = null;
            }
        }
        else
        {
            filterDateFrom = null;
        }
        
        currentPage = 1; // Reset to first page
        await ApplyFiltersAsync();
    }

    private async Task OnDateToChanged(ChangeEventArgs e)
    {
        if (!string.IsNullOrEmpty(e.Value?.ToString()))
        {
            if (DateTime.TryParse(e.Value.ToString(), out DateTime date))
            {
                filterDateTo = date.Date;
            }
            else
            {
                filterDateTo = null;
            }
        }
        else
        {
            filterDateTo = null;
        }
        
        currentPage = 1; // Reset to first page
        await ApplyFiltersAsync();
    }

    private async Task OnPageSizeChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int newPageSize) && newPageSize > 0)
        {
            pageSize = newPageSize;
            currentPage = 1; // Reset to first page
            await ApplyFiltersAsync();
        }
    }

    private void ApplyFilters()
    {
        try
        {
            // Start with all nominations
            var query = nominations.AsEnumerable();

            // Apply service filter
            if (selectedServiceId > 0)
            {
                query = query.Where(n => n.ServiceId == selectedServiceId);
            }

            // Apply date filters
            if (filterDateFrom.HasValue)
            {
                query = query.Where(n => n.ServiceDate >= filterDateFrom.Value.Date);
            }

            if (filterDateTo.HasValue)
            {
                query = query.Where(n => n.ServiceDate <= filterDateTo.Value.Date);
            }

            // Apply sorting
            filteredNominations = query
                .OrderByDescending(n => n.ServiceDate)
                .ThenBy(n => n.ServiceName ?? string.Empty)
                .ThenBy(n => n.RecordType)
                .ToList();

            CalculatePagination();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error applying filters: {ex.Message}";
            Console.WriteLine($"ApplyFilters error: {ex}");
            filteredNominations = new List<RecordNominationDTO>();
            CalculatePagination();
        }
    }

    private async Task ApplyFiltersAsync()
    {
        ApplyFilters();
        await InvokeAsync(StateHasChanged);
    }

    private void CalculatePagination()
    {
        totalPages = (int)Math.Ceiling((double)filteredNominations.Count / pageSize);
        currentPage = Math.Max(1, Math.Min(currentPage, totalPages));
    }

    private void ChangePage(int page)
    {
        currentPage = page;
        StateHasChanged();
    }

    private async Task ClearFilters()
    {
        selectedServiceId = 0;
        filterDateFrom = null;
        filterDateTo = null;
        currentPage = 1;
        
        await ApplyFiltersAsync();
        await ShowSuccess("Filters cleared successfully!");
    }

    private async Task RefreshData()
    {
        await LoadData();
        await ShowSuccess("Data refreshed successfully!");
    }

    private string GetRecordTypeDisplay(string recordType)
    {
        return recordType switch
        {
            "ChurchAttendance" => "Church Attendance",
            "Offering" => "Offering Recording",
            "FirstTimer" => "First Timer",
            "SecondTimer" => "Second Timer",
            "ServicesNote" => "Services Note",
            _ => recordType
        };
    }

    private string GetRecordTypeBadgeClass(string recordType)
    {
        return recordType switch
        {
            "ChurchAttendance" => "bg-primary",
            "Offering" => "bg-success",
            "FirstTimer" => "bg-warning text-dark",
            "SecondTimer" => "bg-info text-dark",
            "ServicesNote" => "bg-secondary",
            _ => "bg-dark"
        };
    }

    private string GetRecordTypeIcon(string recordType)
    {
        return recordType switch
        {
            "ChurchAttendance" => "fas fa-users",
            "Offering" => "fas fa-hand-holding-usd",
            "FirstTimer" => "fas fa-user-plus",
            "SecondTimer" => "fas fa-user-check",
            "ServicesNote" => "fas fa-sticky-note",
            _ => "fas fa-file-alt"
        };
    }

    private string GetLastNameFirst(string fullName)
    {
        if (string.IsNullOrEmpty(fullName) || fullName == "Unknown Worker" || fullName == "Unknown Nominator")
            return fullName;
        
        var parts = fullName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
        {
            return $"{parts[1]}, {parts[0]}";
        }
        return fullName;
    }

    private IEnumerable<IGrouping<string, RecordNominationDTO>> GetRecordTypeCounts()
    {
        return filteredNominations
            .GroupBy(n => n.RecordType)
            .OrderBy(g => g.Key);
    }

   // In the DeleteNomination method, update to:
private async Task DeleteNomination(int nominationId)
{
    try
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", 
            "Are you sure you want to delete this nomination?\nThis action cannot be undone.");
        
        if (!confirmed)
            return;

        isDeleting.Add(nominationId);
        StateHasChanged();

        var success = await RecordNominationService.DeleteNomination(
            nominationId, 
            AuthService.CurrentWorker!.WorkerId
        );

        if (success)
        {
            // Remove from local lists
            nominations = nominations.Where(n => n.Id != nominationId).ToList();
            ApplyFilters(); // Re-apply filters
            await ShowSuccess("Nomination deleted successfully!");
        }
        else
        {
            await ShowError("Failed to delete nomination. You may not have permission.");
        }
    }
    catch (Exception ex)
    {
        Console.WriteLine($"Error deleting nomination: {ex.Message}");
        await ShowError("An error occurred while deleting the nomination.");
    }
    finally
    {
        isDeleting.Remove(nominationId);
        StateHasChanged();
    }
}

// Remove any references to Status in the table
// Just show the basic information without status

    private async Task ShowSuccess(string message)
    {
        try
        {
            successMessage = message;
            await JS.InvokeVoidAsync("showToast", "success", "Success", message);
        }
        catch
        {
            // Fallback if JS is not available
            Console.WriteLine("Success: " + message);
        }
        finally
        {
            // Clear message after 5 seconds
            _ = Task.Delay(5000).ContinueWith(_ => 
            {
                successMessage = null;
                InvokeAsync(StateHasChanged);
            });
        }
    }

    private async Task ShowError(string message)
    {
        try
        {
            errorMessage = message;
            await JS.InvokeVoidAsync("showToast", "error", "Error", message);
        }
        catch
        {
            // Fallback if JS is not available
            Console.WriteLine("Error: " + message);
        }
        finally
        {
            // Clear message after 10 seconds
            _ = Task.Delay(10000).ContinueWith(_ => 
            {
                errorMessage = null;
                InvokeAsync(StateHasChanged);
            });
        }
    }

    private void ClearSuccessMessage()
    {
        successMessage = null;
        StateHasChanged();
    }

    private void ClearErrorMessage()
    {
        errorMessage = null;
        StateHasChanged();
    }

    public void Dispose()
    {
        _cancellationTokenSource?.Cancel();
        _cancellationTokenSource?.Dispose();
    }
}